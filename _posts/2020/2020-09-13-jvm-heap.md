---
layout: post
title: JVM 堆
category: Java
tags: [JVM, 堆]
keywords: JVM,堆
excerpt: JVM 堆是被所有线程共享的一块内存区域，所有对象和数组都在堆上进行内存分配。
---

JVM 堆是被所有线程共享的一块内存区域，所有对象和数组都在堆上进行内存分配。

## JVM 堆内存划分

![](/assets/images/2020/JVM_Heap.png)


1. JVM内存划分为堆内存和非堆内存，堆内存分为年轻代（Young Generation）、老年代（Old Generation），非堆内存就一个永久代（Permanent Generation）。

2. 年轻代又分为 Eden 和 Survivor 区。Survivor 区由 FromSpace 和 ToSpace 组成。Eden 区占大容量，Survivor 两个区占小容量，默认比例是 8:1:1。

3. 堆内存用途：存放的是对象，垃圾收集器就是收集这些对象，然后根据 GC 算法回收。

4. 非堆内存用途：永久代，也称为方法区，存储程序运行时长期存活的对象，比如类的元数据、方法、常量、属性等。

JDK1.8 版本废弃了永久代，替代的是元空间（MetaSpace），元空间与永久代上类似，都是方法区的实现，他们最大区别是：元空间并不在 JVM 中，而是使用本地内存。

元空间有注意有两个参数：

* MetaspaceSize：初始化元空间大小，控制发生 GC 阈值

* MaxMetaspaceSize：限制元空间大小上限，防止异常占用过多物理内存

## 为什么移除永久代？

移除永久代原因：为融合 HotSpot JVM 与 JRockit VM（新 JVM 技术）而做出的改变，因为 JRockit 没有永久代。

有了元空间就不再会出现永久代 OOM 问题了！

## 为什么分代？

将对象根据存活概率进行分类，对存活时间长的对象，放到固定区，从而减少扫描垃圾时间及 GC 频率。针对分类进行不同的垃圾回收算法，对算法扬长避短。

## 为什么 survivor 分为两块相等大小的幸存空间？

主要为了解决碎片化。如果内存碎片化严重，也就是两个对象占用不连续的内存，已有的连续内存不够新对象存放，就会触发 GC。

## JVM 堆内存常用参数

| 参数 | 描述 |
| ----| ---- |
| -Xms | 堆内存初始大小，单位m、g |
| -Xmx（MaxHeapSize） |  	堆内存最大允许大小，一般不要大于物理内存的 80% |
| -XX:NewSize（-Xns） | 年轻代内存初始大小 |
| -XX:MaxNewSize（-Xmn） | 年轻代内存最大允许大小，也可以缩写 |
| -XX:SurvivorRatio=8 | 年轻代中 Eden 区与 Survivor 区的容量比例值，默认为 8，即 8:1 |

## GC 流程

基本所有数据都会保存在 JVM 的堆内存之中。

对于整个的 GC 流程里面，最需要处理的事年轻代与老年代的内存清理操作。

元空间（永久代）都不在 GC 范围内。

![](/assets/images/2020/GC_Flow.png)

**具体流程：**

1. 当现在有一个新的对象产生，JVM需要为该对象进行内存空间的申请。

2. 先判断 Eden 区是否有内存空间，如果有，直接将新对象保存在 Eden 区。

3. 如果 Eden 区的内存空间不足，会自动执行一个 Minor GC 操作，将 Eden 区的无用内存空间进行清理。

4. 清理 Eden 区之后继续判断 Eden 区内存空间情况，如果充足，则将新对象直接保存在 Eden 区

5. 如果执行了 Minor GC 之后发现 Eden 区的内存依然不足，那就判断存活区的内存空间，并将 Eden 区的部分活跃对象保存在存活区。

6. 活跃对象迁移到存活区后，继续判断 Eden 区内存空间情况，如果充足，则将新对象直接保存在 Eden 区。

7. 如果存活区也没有空间了，则继续判断老年区，如果老年区充足，则将存活区的部分活跃对象保存在老年区。

8. 存活区的活跃对象迁移到老年区后，则将 Eden 区的部分活跃对象保存在存活区。

9. 活跃对象迁移到存活区后，继续判断 Eden 区内存空间情况，如果充足，则将新对象直接保存在 Eden 区。

10. 如果老年区也满了，这时候产生 Major GC（Full GC）进行老年区的内存清理。

11. 如果老年区执行了 Major GC 之后发现无法进行对象保存，会产生 OutOfMemoryError 异常。

## 参考

[https://blog.51cto.com/lizhenliang/2164876](https://blog.51cto.com/lizhenliang/2164876)

[https://juejin.im/post/6844903982595309581](https://juejin.im/post/6844903982595309581)
