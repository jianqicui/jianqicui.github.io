---
layout: post
title: UDP 协议解析
category: Network
tags: [UDP]
keywords: UDP
excerpt: 用户数据报协议（UDP，User Datagram Protocol）为应用程序提供了一种无需建立连接就可以发送封装的 IP 数据报的方法。
---

用户数据报协议（UDP，User Datagram Protocol）为应用程序提供了一种无需建立连接就可以发送封装的 IP 数据报的方法。UDP 是一种保留消息边界的简单的面向数据报的协议。UDP 不提供差错纠正、队列管理、重复消除、流量控制和拥塞控制，但提供差错检测（包含我们在传输层中碰到的第一个真实的端到端（end-to-end）校验和）。这种协议自身提供最小功能，因此使用它的应用程序要做许多关于数据报如何发送和处理的控制工作。想要保证数据被可靠传递或正确排序，应用程序必须自己实现这些保护功能。一般来说，每个被应用程序请求的 UDP 输出操作只产生一个 UDP 数据报，从而发送一个 IP 数据报。而对于面向数据流的传输层协议（例如TCP），应用程序写入的全部数据与真正在单个 IP 数据报里传送的或接收方接收的内容可能没有联系。

## UDP 的主要特点

1. UDP 是无连接的，即发送数据之前不需要建立连接，因此减少了开销和发送数据之前的时延。
2. UDP 使用尽最大努力交付，即不保证可靠交付，因此主机不需要维持复杂的连接状态表。
3. UDP 是面向报文的。发送方的 UDP 对应用程序交下来的报文，在添加首部后就向下交付 IP 层。UDP 对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界。因此，应用程序必须选择合适大小的报文。
4. UDP 没有拥塞控制，因此网络出现的拥塞不会使源主机的发送速率降低。很多的实时应用（如IP电话、实时视频会议等）要去源主机以恒定的速率发送数据，并且允许在网络发生拥塞时丢失一些数据，但却不允许数据有太多的时延。UDP 正好符合这种要求。
5. UDP 支持一对一、一对多、多对一和多对多的交互通信。
6. UDP 的首部开销小，只有 8 个字节，比 TCP 的 20 个字节的首部要短。

## UDP 的首部格式

![](/assets/images/2020/UDP_Header.png)

UDP 有两个字段：数据字段和首部字段。首部字段很简单，只有 8 个字节，由 4 个字段组成，每个字段的长度都是两个字节。各字段意义如下：

1. 源端口：源端口号。在需要对方回信时选用。不需要时可用全 0。
2. 目的端口：目的端口号。这在终点交付报文时必须要使用到。
3. 长度：UDP 用户数据报的长度，其最小值是 8（仅有首部），发送一个带 0 字节数据的 UDP 数据报是允许的。值得注意的是，UDP 长度字段是冗余的；IPV4 头部包含了数据报的总长度，同时 IPV6 头部包含了负载长度。因此，一个 UDP/IPV4 数据报的长度等于 IPV4 数据报的总长度减去 IPV4 头部的长度。一个 UDP/IPV6 数据报的长度等于包含在 IPV6 头部中的负载长度（payload length）字段的值减去所有扩展头部（除非使用了超长数据报）的长度。这两种情况下，UDP 长度字段应该与从 IP 层提供的信息计算得到的长度是一致的。
4. 校验和：检测 UDP 用户数据报在传输中是否有错。有错就丢弃。

## UDP 校验和

UDP 校验和是一个端到端的传输层校验和，是对包含了 IP 头部中的源（Source）和目的 IP 地址（Destination Address）字段的 UDP 伪首部计算得到的。它由初始的发送方计算得到，由最终的目的方校验。它在传输中不会被修改（除非它通过一个 NAT ）。IPV4 头部中的校验和只覆盖整个头部（即它不覆盖 IP 分组中的任何数据），它在每个 IP 跳都要被重新计算（因为 IPV4 TTL 字段的值在数据报转发时会被路由器减少）。传输协议（如 TCP、UDP）使用校验和来覆盖它们的头部和数据。对于 UDP 来说，校验和是可选的，而其他的则是强制的。当 UDP 在 IPV6 中使用时，校验和的计算与使用是强制的，因为在 IP 层没有头部校验和。为了给应用程序提供无差错数据，像 UDP 这样的传输层协议，在投递数据到接收方应用程序之前，必须计算校验和或者使用其他差错监测机制。

## 参考

[https://www.cnblogs.com/sxiszero/p/11565108.html](https://www.cnblogs.com/sxiszero/p/11565108.html)
